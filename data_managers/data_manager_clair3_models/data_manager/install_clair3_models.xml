<tool id="data_manager_clair3_models" name="Clair3 model downloader" version="0.0.1" tool_type="manage_data" profile="23.2">
    <requirements>
        <requirement type="package" version="3.12">python</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$tool_directory/model_fetcher.py'
            '{output_file}'
            #if $model_selection.source == 'latest'
                --download_latest
            #elif $model_selection.source == 'chosen'
                --model_list '$model_selection.model_list'
            #end if
    ]]></command>
    <inputs>
        <conditional name="model_selection">
            <param name="source" label="Select the source of the list of models to download" type="select">
                <option value="latest">Latest models from rerio page</option>
                <option value="chosen">User provided list of models</option>
            </param>
            <when value="latest">
            </when>
            <when value="chosen">
                <param name="model_list" type="text" label="List of models to download" help="A space separated list of model to download, e.g. 'r1041_e82_400bps_sup_v430,r1041_e82_400bps_hac_v430'">
                    <validator type="regex" message="Invalid model list. Format is a space separated list of model names (e.g. 'r1041_e82_400bps_sup_v430,r1041_e82_400bps_hac_v430')">^[a-z_0-9,]+$</validator>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="output_file" format="data_manager_clair3_models" label="Downloaded models" />
    </outputs>
    <tests>
        <test> <!-- test1 -->
            <conditional name="model_selection">
                <param name="source" value="chosen"/>
                <param name="model_list" value="r1041_e82_400bps_sup_v500,r1041_e82_400bps_hac_v500" />
            </conditional>
            <output name="output_file">
                <assert_contents>
                    <has_text text='r1041_e82_400bps_sup_v500' />
                </assert_contents>
            </output>
        </test>
        <test> <!-- test2 -->
            <conditional name="model_selection">
                <param name="source" value="latest"/>
            </conditional>
            <output name="output_file">
                <assert_contents>
                    <!-- because we don't know what the names of the latest models are we can only test to see if the data table output is created -->
                    <has_text text='data_tables' />  
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
    Clair3_ is a variant caller for long read data developed at the University of Hong Kong. This tool makes use of models trained to match particular
    sequencing technologies and basecallers. Oxford Nanopore provides a set of models for Clair3 on their Rerio_ page. These tools are designed for
    "research release" under the terms of the "Oxford Nanopore Technologies, Ltd. Public License Version 1.0" license_. This data manager allows
    downloading model files from the Rerio page and installing them on a Galaxy server.

    .. _Clair3: https://github.com/HKU-BAL/Clair3
    .. _Rerio: https://github.com/nanoporetech/rerio
    .. _license: https://github.com/nanoporetech/rerio/blob/master/LICENCE.txt
    ]]>
    </help>
    <citations>
        <citation type="doi">10.1101/2021.12.29.474431v2</citation>
        <citation type="bibtex"><![CDATA[@misc{ONT2024,
            title        = {Rerio},
            author       = {Oxford Nanopore Technologies},
            year         = 2024,
            howpublished = {\url{https://github.com/nanoporetech/rerio}},
            commit       = {c0c8ce6}
    }]]></citation>
    </citations>
</tool>