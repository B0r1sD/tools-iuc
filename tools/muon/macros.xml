<macros>
    <token name="@TOOL_VERSION@">0.1.5</token>
    <token name="@VERSION_SUFFIX@">0</token>
    <token name="@profile@">22.05</token>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@TOOL_VERSION@">muon</requirement>
            <requirement type="package" version="0.10.5">anndata</requirement>
        </requirements>
    </xml>
    <xml name="creators">
        <creator>
            <organization name="European Galaxy Team" url="https://galaxyproject.org/eu/" />
        </creator>
    </xml>
    <xml name="citations">
        <citations>
            <citation type="doi">10.1186/s13059-021-02577-8</citation>
        </citations>
    </xml>

    <xml name="sanitize_query" token_validinitial="string.printable">
        <sanitizer>
            <valid initial="@VALIDINITIAL@">
                <remove value="&apos;" />
            </valid>
       </sanitizer>
    </xml>
    <xml name="sanitize_vectors" token_validinitial="string.digits">
        <sanitizer>
            <valid initial="@VALIDINITIAL@">
                <add value=","/>
            </valid>
        </sanitizer>
    </xml>
    <xml name="version_command">
        <version_command><![CDATA[python -c "import muon as mu;print('Muon version: %s' % mu.__version__)"]]></version_command>
    </xml>

    <token name="@CMD_imports@"><![CDATA[
import mudata as md
import muon as mu
import scanpy as sc
            ]]>
    </token>
    <xml name="inputs_mudata">
        <param name="mdata" type="data" format="h5mu" label="MuData input file"/>
    </xml>
    <token name="@CMD_read_inputs@"><![CDATA[
mdata = md.read('mudata.h5mu')
        ]]>
    </token>
    <token name="@CMD_prettify_stdout@"><![CDATA[ | sed -r '1 s|AnnData object with (.+) = (.*)\s*|\1: \2|g' | sed "s|'||g"  | sed -r 's|^\s*(.*):\s(.*)|[\1]\n-    \2|g' | sed 's|, |\n-    |g'
    ]]></token>
    <token name="@CMD@"><![CDATA[
cp '$mdata' 'mudata.h5mu' &&
cat '$script_file' > '$hidden_output' &&
python '$script_file' >> '$hidden_output' &&
touch 'mudata_info.txt' &&
cat 'mudata_info.txt' @CMD_prettify_stdout@
    ]]>
    </token>

    <xml name="inputs_common_advanced">
        <section name="advanced_common" title="Advanced Options" expanded="false">
            <param name="show_log" type="boolean" checked="false" label="Output Log?" />
        </section>
    </xml>
    <xml name="muon_outputs">
        <data name="mudata_out" format="h5mu" from_work_dir="mudata.h5mu" label="${tool.name} (${method.method}) on ${on_string}: MuData"/>
        <data name="hidden_output" format="txt" label="Log file" >
            <filter>advanced_common['show_log']</filter>
        </data>
    </xml>    
    <token name="@CMD_mudata_write_outputs@"><![CDATA[
mdata.write('mudata.h5mu')
with open('mudata_info.txt','w', encoding='utf-8') as ainfo:
    print(mdata, file=ainfo)
        ]]>
    </token>
</macros>
