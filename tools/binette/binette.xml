<tool id="binette" name="Binette" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Binning refinement tool</description>
    <macros>
        <token name="@TOOL_VERSION@">1.0.5</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@PROFILE@">24.1</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">binette</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[

            #import re

            mkdir -p 'input' 'output' &&

            #set $contig = re.sub('[^\s\w\-\\.]', '_', str($contigs.element_identifier))
            #set $database = re.sub('[^\s\w\-\\.]', '_', str($checkm2_db.element_identifier))

            #for $i, $file in enumerate($collections):
                #set $identifier = re.sub('[^\s\w\-\\.]', '_', str($file.contig2bin_tables.element_identifier))
                ln -s '$file.contig2bin_tables' 'input/${identifier}.tsv' &&
            #end for

            ln -s '$contigs' '${contig}' &&
            ln -s '$checkm2_db' '${database}' &&

            #if $proteins:
                #set $prot = re.sub('[^\s\w\-\\.]', '_', str($proteins.element_identifier))
                ln -s '$proteins' '${prot}' &&
            #end if

            binette
            -b input/*.tsv
            -c '${contig}'
            #if $proteins:
                -p '${prot}'
            #end if
            -m ${min_completeness}
            -t "\${GALAXY_SLOTS:-1}"
            -o 'output/'
            -w ${contamination_weight}
            --checkm2_db '${database}'
            ${low_mem}
        
        ]]>
    </command>
    <inputs>
        <repeat name="collections" title="Contig tables" default="2">
            <param argument="--contig2bin_tables" type="data" format="tabular" label="Input contig table"
                help="Input at least 2 different contig tables. Look into the help section at the bottom for more information!"/>
        </repeat>
        <param argument="--contigs" type="data" format="fasta,fasta.gz" label="Input contig file"/>
        <param argument="--proteins" type="data" format="fasta,fasta.gz" optional="true" label="Input fasta file in Prodigal format"
            help="If this file is provided all predicted genes contain in this file will be skiped"/>
        <param argument="--min_completeness" type="integer" min="0" max="100" value="40" label="Set minimus completeness"
            help="Threshold for bins for the final bin selection"/>
        <param argument="--contamination_weight" type="integer" value="2" label="Set contamination weight"
            help="This weight is used for the scoring the bins. A low weight favor complete bins over low contaminated bins"/>
        <param argument="--checkm2_db" type="data" format="dmnd" label="Input CheckM2 diamond database"
            help="When a CheckM2 diamond database should be used download and input it here. It is optional to used it!"/>
        <param argument="--low_mem" type="boolean" falsevalue="" truevalue="--low_mem" checked="false" label="Use low memory mode for diamond"/>
    </inputs>
    <outputs>
        <collection name="bins" type="list" label="${tool.name} on ${on_string}: Bins">
            <discover_datasets pattern="((?P&lt;designation&gt;.*)\.fa)" format="fasta" directory="output/final_bins"/>
        </collection>
        <collection name="quality" type="list" label="${tool.name} on ${on_string}: Quality Report">
            <discover_datasets pattern="((?P&lt;designation&gt;.*)\.tsv)" format="tabular" directory="output/input_bins_quality_reports"/>
        </collection>
        <data name="final" format="tabular" from_work_dir="output/final_bins_quality_reports.tsv" label="${tool.name} on ${on_string}: Final Quality Report"/>
    </outputs>
    <tests>
        <test expect_num_outputs="3">
            <repeat name="collections">
                <param name="contig2bin_tables" ftype="tabular" value="B.binning"/>
            </repeat>
            <repeat name="collections">
                <param name="contig2bin_tables" ftype="tabular" value="A.binning"/>
            </repeat> 
            <repeat name="collections">
                <param name="contig2bin_tables" ftype="tabular" value="C.binning"/>
            </repeat> 
            <param name="contigs" value="all_contig.fasta.gz" ftype="fasta.gz"/>
            <param name="min_completeness" value="5"/>
            <param name="contamination_weight" value="0"/>
            <param name="checkm2_db" value="checkm2_tiny_db.dmnd"/>
            <param name="low_mem" value="true"/>
            <output name="final" ftype="tabular">
                <assert_contents>
                    <has_text text="binC"/>
                    <has_text text="50"/>
                    <has_text text="9"/>
                </assert_contents>
            </output>
            <output_collection name="bins" count="4"/>
        </test>
        <test expect_num_outputs="3">
            <repeat name="collections">
                <param name="contig2bin_tables" ftype="tabular" value="B.binning"/>
            </repeat>
            <repeat name="collections">
                <param name="contig2bin_tables" ftype="tabular" value="A.binning"/>
            </repeat> 
            <repeat name="collections">
                <param name="contig2bin_tables" ftype="tabular" value="C.binning"/>
            </repeat> 
            <param name="contigs" value="all_contig.fasta.gz" ftype="fasta.gz"/>
            <param name="min_completeness" value="40"/>
            <param name="contamination_weight" value="2"/>
            <param name="checkm2_db" value="checkm2_tiny_db.dmnd"/>
            <param name="proteins" ftype="fasta.gz" value="proteins.fasta.gz"/>
            <output name="final" ftype="tabular">
                <assert_contents>
                    <has_text text="binC"/>
                    <has_text text="50"/>
                    <has_text text="40"/>
                </assert_contents>
            </output>
            <output_collection name="bins" count="4"/>
        </test>
    </tests>
    <help>
        <![CDATA[

        .. class:: infomark

        **What does Binette**

        Binette is a fast and accurate binning refinement tool to constructs high quality MAGs from the output of multiple binning tools.

        **Inputs**

        - At least 2 different contig tables.

        .. class:: infomark

        The contig tables can be generate by the tool *Converts genome bins in fasta format*. This tool only need the bins which where created by any binner as input.

        - The contig file

        .. class:: infomark
        
        This file should contain all reads used to create the bins. The format of this file should be either fasta or fasta.gz.

        - A CheckM2 dimaond databse

        .. class::infomark

        This database can be download with using the CheckM2 package and the followed command: *checkm2 database --download --path <checkm2/database/>*. The format of this file is DMND.

        - An optional (fasta/fasta.gz) file with predicted genes

        **Outputs**

        - A collection (list) with all the selected bins in fasta format.

        - A final quality report file containing quality information about the final selected bins.

        - A collection (list) storing quality reports for the input bin sets, with files following the same structure as the final quality report file.
        
        ]]>
    </help>
    <citations>
        <citation type="doi">10.21105/joss.06782</citation>
    </citations> 
</tool>