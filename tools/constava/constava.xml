<tool id="constava" name="Constava" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="23.00">
    <description>Conformational state variability from protein ensembles</description>
    <macros>
        <token name="@TOOL_VERSION@">1.1.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">constava</requirement>
    </requirements>
    <command detect_errors="exit_code">
    <![CDATA[
    #if $input_options.input_degrees == "Degrees"
        #set angle_units = "--degrees"
    #else
        #set angle_units = ""
    #end if

    #if $pdf.use_pretrained_pdf
        #set model_file = "custom_model.pkl"
        #if $pdf.model_type == "kde"
            constava fit-model -v --kde-bandwidth $pdf.bandwidth $angle_units -i $pdf.train_data -o $model_file
        #else if $pdf.model_type == "grid"
            constava fit-model -v --grid-points $pdf.grid_points --kde-bandwidth $pdf.bandwidth $angle_units -i $pdf.train_data -o $model_file
        #end if
        constava analyze -v -i '$input_files' -o 'output_constava.csv' --load-model $model_file --window $subsampling_options.window_size $angle_units
    #else
        constava analyze -v -i '$input_files' -o 'output_constava.csv' --window $subsampling_options.window_size $angle_units
    #end if
    ]]>
    </command>
    <inputs>
        <section name="input_options" title="Input Options" expanded="true">
            <param type="data" name="input_files" format="csv,xvg" label="Dihedral angles file" help="Upload the CSV or XVG file containing dihedral angles." multiple="true"/>
            <param name="input_format" type="select" label="Input file format" help="Select the format of the input file or choose auto to let the system decide based on the file extension and content.">
                <option value="auto" selected="true">Auto</option>
                <option value="csv">CSV</option>
                <option value="xvg">XVG</option>
            </param>
            <param name="input_degrees" type="select" label="Are the dihedral angles in that file in radians or degrees?" help="Indicate if the dihedral angles are in radians or degrees.">
                <option value="Radians">Radians</option>
                <option value="Degrees" selected="true">Degrees</option>
            </param>
        </section>
       <section name="pdf_options" title="Kernel Options">
            <conditional name="pdf">
                <param name="use_pretrained_pdf" type="boolean" label="Do you want to use custom probability density functions (pdf)?"/>
                <when value="true">
                    <conditional name="sampling_options">
                        <param name="Model_type" type="select" label="Select a Model type ">
                            <option value="kde">KDE model</option>
                            <option value="grid">Grid model</option>
                        </param>
                        <when value="kde">
                            <param name="bandwidth" type="float" label="Which pdf bandwidth do you want to use?" value="0.13" />
                        </when>
                        <when value="grid">
                            <param name="grid_points" type="integer" label="Grid points" value="10000"/>
                            <param name="bandwidth" type="float" label="Which pdf bandwidth do you want to use?" value="0.13" />
                        </when>
                    </conditional>
                    <conditional name="json">
                        <param name="train_pdf" type="boolean" label="Do you want to train probability density functions with custom data?" truevalue="True" falsevalue="False" />
                        <when value="True">
                            <param name="train_data" type="data" format="json" label="File for pdf fitting in JSON format" />
                            <param name="input_degrees" type="select" label="Are the dihedral angles in that file in radians or degrees?" help="Indicate if the dihedral angles are in radians or degrees.">
                                <option value="Radians">Radians</option>
                                <option value="Degrees" selected="true">Degrees</option>
                            </param>
                        </when>
                    </conditional>
                </when>
                <when value="false">
                </when>
            </conditional>
        </section>
        <section name="subsampling_options" title="Subsampling Options">
            <conditional name="sampling_options">
                <param name="subsampling_type" type="select" label="Select a subsampling method to configure" help="You must select and configure at least one subsampling option.">
                    <option value="window">Sliding window</option>
                    <option value="bootstrap">Bootstrap sampling</option>
                </param>
                <when value="window">
                    <param name="window_size" type="text" label="Window size (space-separated integers)" value="3" help="Specify window sizes for moving frame analysis, e.g., '3 5 7'. Each reading frame consists of consecutive samples. Multiple values can be provided."/>
                    <param name="return_window_series" type="boolean" label="Return window series calculation" help="Return the results for every window rather than the average. This can result in very large output files." value="false"/>
                </when>
                <when value="bootstrap">
                    <param name="bootstrap_size" type="text" label="Bootstrap size (space-separated integers)" value="3" help="Specify bootstrap sizes, e.g., '10 20 30'. Samples obtained through bootstrapping. Multiple values can be provided."/>
                    <param name="return_bootstrap_series" type="boolean" label="Return bootstrap series calculation" help="Return the results for every subsample rather than the average. This can result in very large output files." value="false"/>
                    <param name="bootstrap_samples" type="integer" label="Bootstrap samples" value="10000" help="When bootstrapping, sample times from the input data."/>
                    <param name="bootstrap_seed" type="integer" label="Bootstrap seed" value="42" help="Set random seed for bootstrap sampling."/>
                </when>
            </conditional>
        </section>
    </inputs>
    <outputs>
        <data name="file_contents" format="txt" label="${tool.name} on ${on_string}: File Contents" from_work_dir="output_contents.txt"/>
    </outputs>
    <help>
    <![CDATA[
    **Constava** calculates conformational state variability from both experimental and computed protein ensembles, providing insights into the dynamic aspects of protein structure.

Inputs
    - **Input files:** Upload the files containing dihedral angles. Supported formats include CSV and XVG.
    - **Input degrees:** Indicate whether the dihedral angles in your input files are in radians or degrees.

Kernel Options
    Configure probability density functions (PDFs). You can choose to use predefined PDFs or fit your own PDFs from custom data.

Subsampling Options
    Set up different subsampling methods like window-based analysis and bootstrap sampling to analyze data variability.

    - **Window size:** Define sizes for moving frame analysis, which could consist of multiple consecutive samples.
    - **Bootstrap size:** Specify sizes for bootstrap methods to enhance statistical robustness.

Outputs
    - **Output file:** Retrieves the results file that contains calculated variability measures. The format and detail level of this file depend on your configured settings and selections in subsampling options.

    **Note:** This tool requires careful setup of parameters to ensure accurate and meaningful results. Default settings are provided for quick setups but might need adjustments based on your specific data and analysis requirements.
    ]]>
    </help>
    <citations>
        <citation type="doi">doi:10.1093/nargab/lqae082</citation>
    </citations>
</tool>
