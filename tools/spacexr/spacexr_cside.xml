<tool id="spacexr_cside" name="CSIDE" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Cell type-specific differential expression with C-SIDE</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="edam"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        #if $type.cell_types != '':
            #set $cell_types = [str(x.strip()) for x in str($type.cell_types).split(',')]
        #end if
        #if str($type.cell_types_present) != '':
            #set $cell_types_present = [str(x.strip()) for x in str($type.cell_types_present).split(',')]
        #end if
        #if $type.de_type == 'point_density':
            #set $pathologic_barcode = [str(x.strip()) for x in str($type.pathologic_barcode).split(',')]
        #end if
        mkdir -p 'inputs' 'results' 'logs' 'figures' &&
        ln -s '$rctd' 'inputs/rctd.rds' &&
        touch 'results/cside_script.R' &&
        cat '$cside_script' > 'results/cside_script.R' &&
        Rscript '$cside_script'
    ]]></command>
    <configfiles>
        <configfile name="cside_script">
            # cside script
            # This file is used to specify the parameters for the cside from spacexr package

            # Load the spacexr library
            library('spacexr')
            library('Matrix')
            library('doParallel')

            # load RCTD object
            myRCTD &lt;- readRDS('inputs/rctd.rds')
            
            # set core
            myRCTD@config$max_cores &lt;- \${GALAXY_SLOTS:-2}

            # CSIDE
            #if $type.de_type == 'non_parametric':
                myRCTD &lt;- run.CSIDE.nonparam(myRCTD,
                                            df = $type.df,
                                            barcodes = NULL, # use all barcodes
                                            #if $type.cell_type != '':
                                                cell_types = c($cell_type),
                                            #end if
                                            cell_type_threshold = $type.cell_type_threshold,
                                            gene_threshold = $type.gene_threshold,
                                            doublet_mode = $type.doublet_mode,
                                            #if str($weight_threshold) != '':
                                                weight_threshold = $type.weight_threshold,
                                            #end if
                                            sigma_gene = $type.sigma_gene,
                                            PRECISION.THRESHOLD = $type.PRECISION.THRESHOLD,
                                            #if str($cell_types_present) != '':
                                                cell_types_present = c($cell_types_present),
                                            #end if
                                            fdr = $type.fdr
                                            test_genes_sig = $type.test_genes_sig,
                                            logs = $type.logs
                                            )
            #end if
            #if $type.de_type == 'point_density':
                pathogen_coords &lt;- myRCTD@spatialRNA@coords[$pathologic_barcode,]
                barcodes &lt;- colnames(myRCTD@spatialRNA@counts)
                explanatory.variable &lt;- exvar.point.density(myRCTD,
                                                            barcodes,
                                                            pathogen_coords,
                                                            radius = $type.radius
                                                            )
                @SINGLE_RUN@
            #end if
            
            #if $type.de_type == 'point_density':
                barcodes &lt;- colnames(myRCTD@spatialRNA@counts)
                explanatory.variable &lt;- exvar.celltocell.interactions(myRCTD,
                                                                        barcodes,
                                                                        '$type.cell_type',
                                                                        radius = $type.radius
                                                                        )
                @SINGLE_RUN@
            #end if


            # save the results

            # save significant genes in each cell type
            cell_types &lt;- names(myRCTD@de_results$sig_gene_list)
            for (cell_type in cell_types) {
                df &lt;- myRCTD@de_results$sig_gene_list[[cell_type]]
                assign(cell_type, df)
                write.table(df, file = paste0("results/", cell_type, "sig.tabular"), sep = "\t", quote = FALSE)
            }
            # save all genes in each cell type
            cell_types &lt;- names(myRCTD@de_results$all_gene_list)
            for (cell_type in cell_types) {
                df &lt;- myRCTD@de_results$all_gene_list[[cell_type]]
                assign(cell_type, df)
                write.table(df, file = paste0("results/", cell_type, "sig.tabular"), sep = "\t", quote = FALSE)
            }

            # create plots
            #if str($output.plots) == 'True':
                make_all_de_plots(myRCTD, "figures")
            #end if
            # save rds file
            #if str($output.rds) == 'True':
                saveRDS(myRCTD, file = 'results/cside_results.rds')
            #end if
        </configfile>
    </configfiles>
    <inputs>
        <param name="rctd" type="data" format="rds" label="RCTD object" help="annotated RCTD object"/>
        <conditional name="type">
            <param name="de_type" type="select" label="Type of covariates for explaining differential expression with C-SIDE">
                <option value="non_parametric">Smooth spatial pattern (non-non_parametric)</option>
                <option value="point_density">Proximity to pathology</option>
                <option value="cell2cell">Cell-to-cell interaction</option>
                <option value="XY">define X or Y axis</option>
                <option value="custom">Custom spatial locations</option>
            </param>
            <when value="non_parametric">
                <param argument="df" type="integer" min="0" value="15" label="Degrees of freedom" help="The degrees of freedom, or number of basis functions to be used in the model."/>
                <expand macro="common_input"/>
            </when>
            <when value="point_density">
                <param argument="pathologic_barcode" type="text" optional="false" label="Barcodes" help="Comma separated barcodes of the pathological region."/>
                <param argument="radius" type="integer" min="0" value="50" label="Radius" help="The radius of the exponential filter. Approximately, the distance considered to be a relevant interaction."/>
                <expand macro="single_input"/>
            </when>
            <when value="cell2cell">
                <param argument="cell_type" type="text" optional="false" label="Cell type for which to compute density"/>
                <param argument="radius" type="integer" min="0" value="50" label="Radius" help="The radius of the exponential filter. Approximately, the distance considered to be a relevant interaction."/>
                <expand macro="single_input"/>
            </when>
            <when value="XY">
            </when>
            <when value="custom">
            </when>
        </conditional>
        <section name="output" title="Output options">
            <param name="plots" type="boolean" truevalue="True" falsevalue="False" checked="false" label="save plots?"/>
            <param name="rds" type="boolean" truevalue="True" falsevalue="False" checked="true" label="save RDS file?"/>
            <param name="rscript" type="boolean" truevalue="True" falsevalue="False" checked="false" label="save RScript?"/>
        </section>
    </inputs>
    <outputs>

    </outputs>
    <tests>
        
    </tests>
    <help><![CDATA[


    ]]></help>
Cell type-Specific Inference of Differential Expression, or CSIDE, is part of the spacexr R package for learning cell type-specific differential expression from spatial transcriptomics data.

    <expand macro="citations" />
</tool>