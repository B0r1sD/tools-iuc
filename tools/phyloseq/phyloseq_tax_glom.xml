<tool id="phyloseq_tax_glom" name="Phyloseq Taxonomic Agglomeration" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Aggregates a Phyloseq object at a specified taxonomic rank</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        Rscript '${__tool_directory__}/phyloseq_tax_glom.R' '$input_physeq' '$tax_rank' $counts $exclude_na_values 
        #if str($single_rank_cond.exclude_otu_ids) == "exclude_otu_ids":
            --exclude_otu_ids
            $single_rank_cond.single_rank
        #end if
        &&
        mv *_table.tsv '$output'
    ]]></command>
    
    <inputs>
        <param name="input_physeq" type="data" format="rds" label="Phyloseq object"/>
        <param name="tax_rank" type="text" label="Taxonomic rank for agglomeration" help="Specify the rank to merge OTUs at"/>
        <param argument="--counts" truevalue="--counts" falsevalue="" type="boolean" label="Include OTU counts" optional="true" help="OTU abundances will be included in the output"/>
        <param argument="--exclude_na_values" truevalue="--exclude_na_values" falsevalue="" type="boolean" label="Exclude unknown 'NA' values" optional="true" help="Unknown value 'NA' will be removed"/>
        <conditional name="single_rank_cond">
            <param name="exclude_otu_ids" type="select" label="Exclude OTU IDs from output" help="OTU IDs will be excluded from the output table">
                <option value="exclude_otu_ids">Yes</option>
                <option value="">No</option>
            </param>
            <when value="exclude_otu_ids">
                <param argument="--single_rank" truevalue="--single_rank" falsevalue="" type="boolean" label="Keep only specified rank column" optional="true" help="Only the selected taxonomic rank will be kept"/>
            </when>
            <when value=""/>
        </conditional>
    </inputs>
    <outputs>
        <data name="output" format="tabular" label="Agglomerated Taxonomy Table"/>
    </outputs>
    <tests>
        <test>
            <param name="input_physeq" value="SRR1770594.phyloseq"/>
            <param name="tax_rank" value="Genus"/>
            <conditional name="single_rank_cond">
                <param name="exclude_otu_ids" value=""/>
            </conditional>
            <output name="output" file="tax_glom_output0.tabular"/>
        </test>
        <test>
            <param name="input_physeq" value="SRR1770594.phyloseq"/>
            <param name="tax_rank" value="Genus"/>
            <param name="counts" value="true"/>
            <conditional name="single_rank_cond">
                <param name="exclude_otu_ids" value=""/>
            </conditional>
            <output name="output" file="tax_glom_output1.tabular"/>
        </test>
        <test>
            <param name="input_physeq" value="SRR1770594.phyloseq"/>
            <param name="tax_rank" value="Genus"/>
            <param name="exclude_na_values" value="true"/>
            <conditional name="single_rank_cond">
                <param name="exclude_otu_ids" value=""/>
            </conditional>
            <output name="output" file="tax_glom_output2.tabular"/>
        </test>
        <test>
            <param name="input_physeq" value="SRR1770594.phyloseq"/>
            <param name="tax_rank" value="Genus"/>
            <param name="counts" value="true"/>
            <param name="exclude_na_values" value="true"/>
            <conditional name="single_rank_cond">
                <param name="exclude_otu_ids" value="exclude_otu_ids"/>
            </conditional>
            <output name="output" file="tax_glom_output3.tabular"/>
        </test>
        <test>
            <param name="input_physeq" value="SRR1770594.phyloseq"/>
            <param name="tax_rank" value="Genus"/>
            <param name="counts" value="true"/>
            <param name="exclude_na_values" value="true"/>
            <conditional name="single_rank_cond">
                <param name="exclude_otu_ids" value="exclude_otu_ids"/>
                <param name="single_rank" value="true"/>
            </conditional>
            <output name="output" file="tax_glom_output4.tabular"/>
        </test>
        <test>
            <param name="input_physeq" value="SRR1770594.phyloseq"/>
            <param name="tax_rank" value="Genus"/>
            <param name="counts" value="true"/>
            <param name="exclude_na_values" value="true"/>
            <conditional name="single_rank_cond">
                <param name="exclude_otu_ids" value=""/>
            </conditional>
            <output name="output" file="tax_glom_output5.tabular"/>
        </test>
    </tests>
    <help>
        **What it does**
        
        This tool performs taxonomic agglomeration on a Phyloseq object, merging OTUs at a specified taxonomic rank.
        
        **Options:**
        
        - *Taxonomic rank for agglomeration:* Specify the rank to merge OTUs at.
        - *Include OTU counts:* If enabled, OTU abundances will be included in the output.
        - *Exclude OTU IDs:* If enabled, OTU IDs will be excluded from the output table.
        - *Keep only specified rank column:* If enabled, only the selected taxonomic rank will be kept.
        - *Exclude NA values:* If enabled, unknown will be removed.
        
        **Output**
        
        The output is a tab-separated table containing taxonomic information.
    </help>
    <expand macro="citations"/>
    <creator>
        <person givenName="Rand" familyName="Zoabi" url="https://github.com/RZ9082" identifier="https://orcid.org/0009-0000-2501-8053"/>
    </creator>
</tool>
