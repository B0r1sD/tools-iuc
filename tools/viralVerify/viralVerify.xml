<tool id="viralverify" name="viralverify" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
   <description>
      Classify contigs as viral, non-viral or uncertain, based on gene content
   </description>
   <macros>
      <token name="@TOOL_VERSION@">1.1</token>
      <token name="@VERSION_SUFFIX@">0</token>
      <token name="@PROFILE@">23.2</token> 
   </macros>
   <requirements>
      <requirement type="package" version="@TOOL_VERSION@">viralverify</requirement>
   </requirements>
	<command detect_errors="exit_code"><![CDATA[
ln -s '$input_fasta' 'contigs.fasta' &&
viralverify
    -f 'contigs.fasta'
    -o .
    --hmm '$hmm'
	## OPTIONNAL BLAST NOT TESTED YET
	##  #if '$locdb'
	## 	--db $locdb
	##  #end if 
	##  #if '$histdb'
	## 	--db '$histdb'
	##  #end if
    --thr $thr
    -t \${GALAXY_SLOTS:-1}
    $plasmid_detect
	]]></command>
	<inputs>
       <!--MANDATORY :-->
		 <!-- INPUT FASTA FILE-->
		<param name="input_fasta" type="data" format="fasta" label="Fasta file containing contigs to predict"/>
		<!-- INPUT HMM PROFILE -->
		<param argument="--hmm" type="data" format="hmm3" label="HMM profile"/>
      <!-- OPTIONAL : -->
		<!-- RUN BLAST -->
		<!-- Trying to implement the - -db option here but im currently unable to test it with a blastdbn file -->
		<!-- <conditional name="do_run_blast"> 
			<param name="runblast" type="select" label="Run BLAST on input contigs?" >
				<option value="locdb" selected="true">With locally installed BLAST database </option>
				<option value="histdb" selected="false">With BLAST database from your history </option>
				<option value="no_blast">No </option>
			</param>
				<when value="locdb">
                <param name="database" type="select" multiple="true" optional="false" label="Nucleotide BLAST database">
                    <options from_data_table="blastdb" />
                </param>
                <param name="histdb" type="hidden" value="" />
                <param name="subject" type="hidden" value="" />
            </when>
            <when value="histdb">
                <param name="database" type="hidden" value="" />
                <param name="histdb" type="data" format="blastdbn" label="Nucleotide BLAST database" />
                <param name="subject" type="hidden" value="" />
            </when>
				<when value="no_blast"/>
		</conditional> -->
		<!-- RUN PLASMID DETECTION -->
		<param name="plasmid_detect" type="boolean" truevalue="-p" falsevalue='' checked="false" label="plasmid prediction" help="if checked, plasmid detection will be enabled."/>
		<!-- SENSITIVITY THRESHOLD -->
		<param argument="--thr" type="integer" value="7" label="Sensitivity threshold" help="Minimal absolute score to classify sequence, default = 7"/>
		<!--OUTPUTS CONTROL-->
		<param name="outputs" type="select" multiple="true" label="Which outputs should be generated" help="Warning: If plasmid prediction is not checked, plasmid outputs won't be generated.">
			<option value="viral_pred" selected="true" >Predicted viral contigs(fasta)</option>
			<option value="Unc_viral_pred" selected="true">Uncertain viral contigs(fasta)</option>
			<option value="plasmid_pred" selected="false">Predicted plasmid contigs(fasta)(plasmid prediction must be checked)</option>
			<option value="Unc_plasmid_pred" selected="false">Uncertain plasmid contigs(fasta)</option>
			<option value="chromosomal_pred" selected="true">Predicted chromosomal contigs(fasta)(plasmid prediction must be checked)</option>
			<option value="result_table" selected="true">Table with contig predictions</option>
			<option value="prodigal_report" selected="false">Prodigal report</option>
			<option value="prodigal_genbank" selected="false">Prodigal genbank file</option>
			<option value="prodigal_proteins_circ" selected="false">Prodigal proteins (circular)</option>
			<option value="prodigal_proteins" selected="false">Prodigal proteins (linear)</option>
			<option value="hmmsearch_report" selected="false">HMM search report</option>
			<option value="hmmsearch_domtblout" selected="false">hmmsearch output</option>
		</param>
	</inputs>    
	<outputs> 
		<!-- VIRAL PREDICTIONS -->
      <data name="predicted_viral" format="fasta" label="${tool.name} on ${on_string}: Predicted viral contigs" from_work_dir="Prediction_results_fasta/contigs_virus.fasta">
			<filter>outputs and 'viral_pred' in outputs</filter>
		</data>
		<data name="uncertain_viral" format="fasta" label="${tool.name} on ${on_string}: Uncertain viral contigs" from_work_dir="Prediction_results_fasta/contigs_virus_uncertain.fasta">	
			<filter>outputs and 'Unc_viral_pred' in outputs</filter>
		</data>
		<!-- PLASMID PREDICTIONS -->
		<data name="predicted_plasmid" format="fasta" label="${tool.name} on ${on_string}: Predicted plasmid contigs" from_work_dir="Prediction_results_fasta/contigs_plasmid.fasta">
			<filter>outputs and 'plasmid_pred' in outputs</filter>
			<filter>plasmid_detect</filter>
		</data>
		<data name="uncertain_plasmid" format="fasta" label="${tool.name} on ${on_string}: Uncertain plasmid contigs" from_work_dir="Prediction_results_fasta/contigs_plasmid_uncertain.fasta">
			<filter>outputs and 'Unc_plasmid_pred' in outputs</filter>
			<filter>plasmid_detect</filter>
		</data>
		<!-- CHROMOSOME PREDICTIONS -->
		<data name="chromosomal" format="fasta" label="${tool.name} on ${on_string}: Predicted chromosomal contig contigs" from_work_dir="Prediction_results_fasta/contigs_uncertain_plasmid.fasta">	
			<filter>outputs and 'chromosomal_pred' in outputs</filter>
		</data>
		<!-- TABLE ALL PREDICTIONS + FEATURES -->
		<data name="result_table" format="csv" label="${tool.name} on ${on_string}: Table with contig predictions" from_work_dir="contigs_result_table.csv">	
			<filter>outputs and 'result_table' in outputs</filter>
		</data>
		<!-- PRODIGAL OUTPUTS -->
		<data name="prodigal_report" format="txt" label="${tool.name} on ${on_string}: Prodigal report" from_work_dir="contigs_prodigal.log">	
			<filter>outputs and 'prodigal_report' in outputs</filter>
		</data>
		<data name="prodigal_genbank" format="genbank" label="${tool.name} on ${on_string}: Prodigal genbank file" from_work_dir="contigs_genes.fa">	
			<filter>outputs and 'prodigal_genbank' in outputs</filter>
		</data>
		<data name="prodigal_proteins_circ" format="fasta" label="${tool.name} on ${on_string}: Prodigal proteins (circular)" from_work_dir="contigs_proteins_circ.fa">
			<filter>outputs and 'prodigal_proteins_circ' in outputs</filter>
		</data>
		<data name="prodigal_proteins" format="fasta" label="${tool.name} on ${on_string}: Prodigal proteins (linear)" from_work_dir="contigs_proteins.fa">
			<filter>outputs and 'prodigal_proteins' in outputs</filter>
		</data>
		<!-- HMMSEARCH OUTPUTS -->
		<data name="hmmsearch_report" format="txt" label="${tool.name} on ${on_string}: HMM search report" from_work_dir="contigs_out_pfam.txt">
			<filter>outputs and 'hmmsearch_report' in outputs</filter>
		</data>
		<data name="hmmsearch_domtblout" format="txt" label="${tool.name} on ${on_string}: hmmsearch output" from_work_dir="contigs_domtblout">
			<filter>outputs and 'hmmsearch_domtblout' in outputs</filter>
		</data>
	</outputs>
	<tests>
		<test expect_num_outputs="12">
    		<param name="input_fasta" value="test.fa"/>
    		<param name="hmm" value="test.hmm"/>
    		<param name="plasmid_detect" value="true"/>
			<param name="thr" value="7"/>
			<param name="outputs" value="viral_pred,Unc_viral_pred,chromosomal_pred,plasmid_pred,Unc_plasmid_pred,result_table,prodigal_report,prodigal_genbank,prodigal_proteins_circ,prodigal_proteins,hmmsearch_report,hmmsearch_domtblout"/>
			<!-- <conditional name="do_run_blast">
				<param name="runblast" value="no_blast" />
			</conditional> -->
    		<output name="uncertain_viral">
        		<assert_contents>
            	<has_text_matching expression=">NC_045512.2 Severe acute respiratory syndrome coronavirus 2 isolate Wuhan-Hu-1, complete genome" />
					<has_text_matching expression=">NC_001416.1 Enterobacteria phage lambda, complete genome" />
					<has_text_matching expression=">NZ_CP021331.1 Maritalea myrionectae strain HL2708#5 plasmid pHL2708X3, complete sequence" />
					<has_text_matching expression=">CP045262.1 Yersinia pestis strain SCPM-O-B-5942 (I-2638) plasmid pPCP, complete sequence" />
					<has_text_matching expression=">NC_000913.3:1-30000 Escherichia coli str. K-12 substr. MG1655, complete genome" />
        		</assert_contents>
    		</output>
    		<output name="predicted_viral">
        		<assert_contents>
            	<not_has_text text=">NC_045512.2 Severe acute respiratory syndrome coronavirus 2 isolate Wuhan-Hu-1, complete genome" />
					<not_has_text text=">NC_001416.1 Enterobacteria phage lambda, complete genome" />
					<not_has_text text=">NZ_CP021331.1 Maritalea myrionectae strain HL2708#5 plasmid pHL2708X3, complete sequence" />
					<has_text_matching expression=">CP045262.1 Yersinia pestis strain SCPM-O-B-5942 (I-2638) plasmid pPCP, complete sequence" />
					<has_text_matching expression=">NC_000913.3:1-30000 Escherichia coli str. K-12 substr. MG1655, complete genome" />
        		</assert_contents>
    		</output>
			<output name="result_table">
				<assert_contents>
					<has_n_columns n="6"></has_n_columns>
					<has_line_matching expression="Contig name,Prediction,Length,Circular,Score,Pfam hits"></has_line_matching>
				</assert_contents>
			</output>
		</test>
	</tests>
		<help>
<![CDATA[
required arguments:

	-f F       Input fasta file
	-o O       Output directory
	--hmm HMM  Path to HMM database

optional arguments:

	--db DB    Run BLAST on input contigs with provided database
	-t T       Number of threads
	--thr THR  Sensitivity threshold (minimal absolute score to classify
						 sequence, default = 7)
	-p         Output predicted plasmids separately 
]]>
		</help>
	<citations>
		<citation type="bibtex">
@misc{viralverify2023,
	author = {Author Name}, 
	title = {ViralVerify: Classify contigs as viral or non-viral based on gene content},
	year = {2023},
	howpublished = {\url{https://github.com/ablab/viralVerify/}}
}
		</citation>
	</citations>
</tool>

