<tool id="viralverify" name="viralverify" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
   <description>
      Classify contigs as viral, non-viral or uncertain, based on gene content
   </description>
   <macros>
      <token name="@TOOL_VERSION@">1.1</token>
      <token name="@VERSION_SUFFIX@">0</token>
      <token name="@PROFILE@">23.2</token> 
   </macros>
   <requirements>
      <requirement type="package" version="@TOOL_VERSION@">viralverify</requirement>
   </requirements>
	<command detect_errors="exit_code"><![CDATA[
ln -s '$input_fasta' 'contigs.fasta' &&
viralverify
    -f 'contigs.fasta'
    -o .
    --hmm '$hmm'
	## OPTIONNAL BLAST NOT TESTED YET
	##  #if '$locdb'
	## 	--db $locdb
	##  #end if 
	##  #if '$histdb'
	## 	--db '$histdb'
	##  #end if
    --thr $thr
    -t \${GALAXY_SLOTS:-1}
    $plasmid_detect
	]]></command>
	<inputs>
       <!--MANDATORY :-->
		 <!-- INPUT FASTA FILE-->
		<param name="input_fasta" type="data" format="fasta" label="Fasta file containing contigs to predict"/>
		<!-- INPUT HMM PROFILE -->
		<param argument="--hmm" type="data" format="hmm3" label="HMM profile"/>
      <!-- OPTIONAL : -->
		<!-- RUN BLAST -->
		<!-- Trying to implement the - -db option here but im currently unable to test it with a blastdbn file -->
		<!-- <conditional name="do_run_blast"> 
			<param name="runblast" type="select" label="Run BLAST on input contigs?" >
				<option value="locdb" selected="true">With locally installed BLAST database </option>
				<option value="histdb" selected="false">With BLAST database from your history </option>
				<option value="no_blast">No </option>
			</param>
				<when value="locdb">
                <param name="database" type="select" multiple="true" optional="false" label="Nucleotide BLAST database">
                    <options from_data_table="blastdb" />
                </param>
                <param name="histdb" type="hidden" value="" />
                <param name="subject" type="hidden" value="" />
            </when>
            <when value="histdb">
                <param name="database" type="hidden" value="" />
                <param name="histdb" type="data" format="blastdbn" label="Nucleotide BLAST database" />
                <param name="subject" type="hidden" value="" />
            </when>
				<when value="no_blast"/>
		</conditional> -->
		<!-- RUN PLASMID DETECTION -->
		<param name="plasmid_detect" type="boolean" truevalue="-p" falsevalue='' checked="false" label="plasmid prediction" help="if checked, plasmid detection will be enabled."/>
		<!-- SENSITIVITY THRESHOLD -->
		<param argument="--thr" type="integer" value="7" label="Sensitivity threshold" help="Minimal absolute score to classify sequence, default = 7"/>
	</inputs>    
	<outputs> 
		<!-- VIRAL PREDICTIONS -->
      <data name="predicted_viral" format="fasta" label="${tool.name} on ${on_string}: Predicted viral contigs" from_work_dir="Prediction_results_fasta/contigs_virus.fasta"/>
		<data name="uncertain_viral" format="fasta" label="${tool.name} on ${on_string}: Uncertain viral contigs" from_work_dir="Prediction_results_fasta/contigs_virus_uncertain.fasta"/>
		<!-- PLASMID PREDICTIONS -->
		<data name="predicted_plasmid" format="fasta" label="${tool.name} on ${on_string}: Predicted plasmid contigs" from_work_dir="Prediction_results_fasta/contigs_plasmid.fasta"/>
		<data name="uncertain_plasmid" format="fasta" label="${tool.name} on ${on_string}: Uncertain plasmid contigs" from_work_dir="Prediction_results_fasta/contigs_plasmid_uncertain.fasta"/>
		<!-- CHROMOSOME PREDICTIONS -->
		<data name="chromosomal" format="fasta" label="${tool.name} on ${on_string}: Predicted chromosomal contig contigs" from_work_dir="Prediction_results_fasta/contigs_uncertain_plasmid.fasta"/>
		<!-- TABLE ALL PREDICTIONS + FEATURES -->
		<data name="result_table" format="csv" label="${tool.name} on ${on_string}: Table with contig predictions" from_work_dir="contigs_result_table.csv"/>
		<!-- PRODIGAL OUTPUTS -->
		<data name="prodigal_report" format="txt" label="${tool.name} on ${on_string}: Prodigal report" from_work_dir="contigs_prodigal.log"/>
		<data name="prodigal_genbank" format="genbank" label="${tool.name} on ${on_string}: Prodigal genbank file" from_work_dir="contigs_genes.fa"/>
		<data name="prodigal_proteins_circ" format="fasta" label="${tool.name} on ${on_string}: Prodigal proteins (circular)" from_work_dir="contigs_proteins_circ.fa"/>
		<data name="prodigal_proteins" format="fasta" label="${tool.name} on ${on_string}: Prodigal proteins (linear)" from_work_dir="contigs_proteins.fa"/>
		<!-- HMMSEARCH OUTPUTS -->
		<data name="hmmsearch_report" format="txt" label="${tool.name} on ${on_string}: HMM search report" from_work_dir="contigs_out_pfam.txt"/>
		<data name="hmmsearch_domtblout" format="txt" label="${tool.name} on ${on_string}: hmmsearch output" from_work_dir="contigs_domtblout"/>
	</outputs>
	<tests>
		<test expect_num_outputs="1">
    		<param name="input_fasta" value="test.fa"/>
    		<param name="hmm" value="test.hmm"/>
    		<param name="plasmid_detect" value="true"/>
			<!-- <conditional name="do_run_blast">
				<param name="runblast" value="no_blast" />
			</conditional> -->
    		<output name="predicted_viral">
        		<assert_contents>
            	<has_text_matching expression="^>NC_045512.2 Severe" />
        		</assert_contents>
    		</output>
		</test>
	</tests>
		<help>
<![CDATA[
required arguments:

	-f F       Input fasta file
	-o O       Output directory
	--hmm HMM  Path to HMM database

optional arguments:

	--db DB    Run BLAST on input contigs with provided database
	-t T       Number of threads
	--thr THR  Sensitivity threshold (minimal absolute score to classify
						 sequence, default = 7)
	-p         Output predicted plasmids separately 
]]>
		</help>
	<citations>
		<citation type="bibtex">
@misc{viralverify2023,
	author = {Author Name}, 
	title = {ViralVerify: Classify contigs as viral or non-viral based on gene content},
	year = {2023},
	howpublished = {\url{https://github.com/ablab/viralVerify/}}
}
		</citation>
	</citations>
</tool>

