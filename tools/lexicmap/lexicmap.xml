<tool id="lexicmap_search" name="LexicMap Search" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE_VERSION@">
    <description>
        A nucleotide sequence alignment tool for efficiently querying genomes.
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements"/>

    <command detect_errors="exit_code"><![CDATA[
    
lexicmap search 

    --threads \${GALAXY_SLOTS:-1}

    ${advanced_settings.load_whole_seeds}

    #if $db_opts.db_opts_selector == "histdb"
        --index '${db_opts.histdb.extra_files_path}'
    #else:
        --index '${db_opts.lexicmap_index.fields.path}'
    #end if

    $query --out-file $out_file

    #if $top_n_genomes
        --top-n-genomes ${top_n_genomes}
    #end if

    #if $advanced_settings.max_open_files
        --max-open-files ${advanced_settings.max_open_files}
    #end if

    #if $advanced_settings.align_band
        --align-band ${advanced_settings.align_band}
    #end if

    #if $advanced_settings.align_ext_len
        --align-ext-len ${advanced_settings.align_ext_len}
    #end if

    #if $advanced_settings.align_max_gap
        --align-max-gap ${advanced_settings.align_max_gap}
    #end if

    #if $advanced_settings.align_min_match_len
        --align-min-match-len ${advanced_settings.align_min_match_len}
    #end if

    #if $advanced_settings.align_min_match_pident
        --align-min-match-pident ${advanced_settings.align_min_match_pident}
    #end if

    ${advanced_settings.all}

    #if $advanced_settings.max_evalue
        --max-evalue ${advanced_settings.max_evalue}
    #end if

    #if $advanced_settings.max_query_conc
        --max-query-conc ${advanced_settings.max_query_conc}
    #end if

    #if $advanced_settings.min_qcov_per_genome
        --min-qcov-per-genome ${advanced_settings.min_qcov_per_genome}
    #end if

    #if $advanced_settings.min_qcov_per_hsp
        --min-qcov-per-hsp ${advanced_settings.min_qcov_per_hsp}
    #end if

    #if $advanced_settings.seed_max_dist
        --seed-max-dist ${advanced_settings.seed_max_dist}
    #end if

    #if $advanced_settings.seed_max_gap
        --seed-max-gap ${advanced_settings.seed_max_gap}
    #end if

    #if $advanced_settings.seed_min_prefix
        --seed-min-prefix ${advanced_settings.seed_min_prefix}
    #end if

    #if $advanced_settings.seed_min_single_prefix
        --seed-min-single-prefix ${advanced_settings.seed_min_single_prefix}
    #end if

    ]]></command>
    <inputs>
        <param name="query" type="data" format="fasta.gz" label="LexicMap query file" multiple="true"  help=""/>
        <conditional name="db_opts">
            <param name="db_opts_selector" type="select" label="LexiMap index source">
              <option value="histdb" selected="true">From your history</option>
              <option value="db">Locally installed LexicMap indexes</option>
            </param>
            <when value="histdb">
                <param name="histdb" type="data" format="lexicmap_index" optional="false" label="LexicMap index" />
            </when>
            <when value="db">
                <param name="lexicmap_index" type="select" optional="false" label="LexicMap index file">
                    <options from_data_table="lexicmap_index"/>
                </param>
            </when>
        </conditional>
            <param name="top_n_genomes" type="integer" value="0" label="Keep top N genome matches for a query (0 for all)" multiple="false" />
        <section name="advanced_settings" title="Advanced settings" expanded="false">
            <param name="align_band" type="integer" optional="true" label="Align band" help="Band size in backtracking the score matrix (pseudo alignment" multiple="false" />
            <param name="align_ext_len" type="integer" optional="true" label="Align extend length" help="Extend length of upstream and downstream of seed regions, for extracting query and target sequences for alignment. It should be &lt;= contig interval length in database." />
            <param name="align_max_gap" type="integer" optional="true" label="Align max gap" help="Maximum gap in a HSP segment." />
            <param name="align_min_match_len" type="integer" optional="true" label="Align min match length" help="Minimum aligned length in a HSP segment." />
            <param name="align_min_match_pident" type="float" optional="true" label="Align min match pident" help="Minimum base identity (percentage) in a HSP segment." />
            <param name="all" type="boolean" truevalue="--all" falsevalue="" checked="false" label="All all columns" help="Output more columns, e.g., matched sequences. Use this if you want to output blast-style format with 'lexicmap utils 2blast'." />
            <param name="load_whole_seeds" type="boolean" truevalue="--load-whole-seeds" falsevalue="" checked="false" label="Load whole seeds" help="Load the whole seed data into memory for faster search" />
            <param name="max_evalue" type="float" optional="true" label="Max evalue" help="Maximum evalue of a HSP segment." />
            <param name="max_open_files" type="integer" optional="true" label="Max open files" help="Maximum number of open files" multiple="false" />
            <param name="max_query_conc" type="integer" optional="true" label="Max query conc" help="Maximum number of concurrent queries. Bigger values do not improve the batch searching speed and consume much memory." />
            <param name="min_qcov_per_genome" type="float" optional="true" label="Min qcov per genome" help="Minimum query coverage (percentage) per genome." />
            <param name="min_qcov_per_hsp" type="float" optional="true"  label="Min qcov per hsp" help="Minimum query coverage (percentage) per HSP." />
            <param name="seed_max_dist" type="integer" optional="true" label="Seed max dist" help="Minimum distance between seeds in seed chaining. It should be &lt;= contig interval length in database." />
            <param name="seed_max_gap" type="integer" optional="true" label="Seed max gap" help="Minimum gap in seed chaining." />
            <param name="seed_min_prefix" type="integer" optional="true" label="Seed min prefix" help="Minimum (prefix/suffix) length of matched seeds (anchors)." />
            <param name="seed_min_single_prefix" type="integer" optional="true" label="Seed min single prefix" help="Minimum (prefix/suffix) length of matched seeds (anchors) if there's only one pair of seeds matched." />
        </section>
    </inputs>
    <outputs>
        <data name="out_file" format="tsv" />
    </outputs>
    <tests>
        <test>
            <conditional name="db_opts">
                <param name="db_opts_selector" value="db"/>
                <param name="lexicmap_index" value="LexicMapIndex1" />
            </conditional>
            <param name="query" value="lexicmap_query.fasta.gz" />
            <section name="advanced_settings">
                <param name="load_whole_seeds" value="true" />
            </section>
            <output name="out_file" value="lexicmap_query_result.tsv" />
        </test>
    </tests>
    <help><![CDATA[
    
    Search sequences against an LexicMap index Database. For more information about settings
    please visit: https://bioinf.shenwei.me/LexicMap/usage/search

    @info@
        ]]></help>
    <expand macro="citations" />
</tool>