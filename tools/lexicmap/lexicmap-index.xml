<tool id="lexicmap_index" name="LexicMap Index" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" python_template_version="3.5" profile="@PROFILE_VERSION@">
    <description>
        This tool builds LexicMap index.
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements"/>

    <command detect_errors="exit_code"><![CDATA[

echo $input_genomes | sed 's/,/\n/g' > \$(pwd)/fasta_list.tsv &&
mkdir '$index.extra_files_path' &&
lexicmap index 

    --threads \${GALAXY_SLOTS:-1}

    -X \$(pwd)/fasta_list.tsv -O '$index.extra_files_path'

    #if $advanced_settings.batch_size
        --batch-size ${batch_size}
    #end if 

    #if $advanced_settings.big_genomes
        --big-genomes ${big_genomes}
    #end if

    #if $advanced_settings.chunks
        --chunks ${chunks}
    #end if

    #if $advanced_settings.contig_interval
        --contig-interval ${contig_interval}
    #end if

    #if $advanced_settings.file_regexp
        --file-regexp ${file_regexp}
    #end if

    #if $advanced_settings.kmer
        --kmer ${kmer}
    #end if

    #if $advanced_settings.mask_file
        --mask-file ${mask_file}
    #end if

    #if $advanced_settings.masks
        --masks ${masks}
    #end if

    #if $advanced_settings.max_genome
        --max-genome ${max_genome}
    #end if

    #if $advanced_settings.max_open_files
        --max-open-files ${max_open_files}
    #end if

    #if $advanced_settings.min_seq_len
        --min-seq-len ${min_seq_len}
    #end if

    #if $advanced_settings.partitions
        --partitions ${partitions}
    #end if

    #if $advanced_settings.rand_seed
        --rand-seed ${rand_seed}
    #end if

    #if $advanced_settings.ref_name_regexp
        --ref-name-regexp ${ref_name_regexp}
    #end if

    #if $advanced_settings.seed_data_threads
        --seed-data-threads ${seed_data_threads}
    #end if

    #if $advanced_settings.seed_in_desert_dist
        --seed-in-desert-dist ${seed_in_desert_dist}
    #end if

    #if $advanced_settings.seed_max_desert
        --seed-max-desert ${seed_max_desert}
    #end if

    #if $advanced_settings.seq_name_filter
        --seq-name-filter ${seq_name_filter}
    #end if

    ]]></command>
    <inputs>
        <param name="input_genomes" format="@FASTA_TYPES@" type="data" multiple="true" label="FASTA files" help="Should be of datatype &quot;fasta.gz&quot; or &quot;fasta&quot;"  />
        <section name="advanced_settings" title="Advanced settings" expanded="false">
            <param name="batch_size" type="integer" optional="true" label="Batch Size" help="Maximum number of genomes in each batch (maximum value: 131072)" />
            <param name="big_genomes" type="text" optional="true" label="Big Genomes skiped output file" help="Out file of skipped files with $total_bases + ($num_contigs - 1) * $contig_interval &lt;= -g/--max-genome. The second column is one of theskip types: no_valid_seqs, too_large_genome, too_many_seqs." />
            <param name="chunks" type="integer" optional="true" label="Number of chunks" help="Number of chunks for storing seeds (k-mer-value data) files. Max: 128. Default: the value of -j/--threads." />
            <param name="contig_interval" type="integer" optional="true" label="Contig interval" help="Length of interval (N's) between contigs in a genome. It can't betoo small (&gt;1000) or some alignments might be fragmented" />
            <param name="file_regexp" type="text" optional="true" label="Sequence file regex" help="Regular expression for matching sequence files in -I/--in-dir, case ignored. Attention: use double quotation marks for patterns containing commas, e.g., -p '&quot;A{2,}&quot;'. (default &quot;\\.(f&#91;aq&#93;(st&#91;aq&#93;)?|fna)(\\.gz|\\.xz|\\.zst|\\.bz2)?$&quot;)" />
            <param name="kmer" type="integer" optional="true" label="Max k-mer size" help="Maximum k-mer size. K needs to be &gt;= 32." />
            <param name="mask_file" type="data" optional="true" label="Mask file" help="File of custom masks. This flag oversides -k/--kmer, -m/--masks, -s/--rand-seed etc." />
            <param name="masks" type="integer" optional="true" label="LexicHash masks" help="Number of LexicHash masks." />
            <param name="max_genome" type="integer" optional="true" label="Max genome size" help="Maximum genome size. Genomes with any single contig larger than the threshold will be skipped, while fragmented (with many contigs) genomes larger than the threshold will be split into chunks and alignments from these chunks will be merged in &quot;lexicmap search&quot;. The value needs to be smaller than the maximum supported genome size: 268435456." />
            <param name="max_open_files" type="integer" optional="true" label="Max open files" help="Maximum opened files, used in merging indexes. If there are &lt;100 batches, please increase this value and set a bigger &quot;ulimit -n&quot; in shell." />
            <param name="min_seq_len" type="integer" optional="true" label="Max sequence length" help="Maximum sequence length to index. The value would be k for values &gt;= 0." />
            <param name="partitions" type="integer" optional="true" label="Number of partitions" help="Number of partitions for indexing seeds (k-mer-value data) files. The value needs to be the power of 4." />
            <param name="rand_seed" type="integer" optional="true" label="Rand seed" help="Rand seed for generating random masks." />
            <param name="ref_name_regexp" type="text" optional="true" label="Reference name regular exptression" help="Regular expression (must contains &quot;(&quot; and &quot;)&quot;) for extracting the reference name from the filename. Attention: use double quotation marks for patterns containing commas, e.g., -p '&quot;A{2,}&quot;'. (default &quot;(?i)(.+)\\.(f&#91;aq&#93;(st&#91;aq&#93;)?|fna)(\\.gz|\\.xz|\\.zst|\\.bz2)?$\&quot;" />
            <param name="seed_data_threads" type="integer" optional="true" label="Seed data threads" help="Number of threads for writing seed data and merging seed chunks from all batches, the value should be in range of &#91;1, -c/--chunks&#93;. If there are &lt;100 batches, please also increase the value of --max-open-files and set a bigger &quot;ulimit -n&quot; in shell." />
            <param name="seed_in_desert_dist" type="integer" optional="true" label="Seed in desert dist" help="Distance of k-mers to fill deserts." />
            <param name="seed_max_desert" type="integer" optional="true" label="Seed max desert" help="Maximum length of sketching deserts, or maximum seed distance. Deserts with seed distance larger than this value will be filled by choosing k-mers roughly every --seed-in-desert-dist bases." />
            <param name="seq_name_filter" type="text" optional="true" label="Sequence name filter" help="List of regular expressions for filtering out sequences by contents in FASTA/Q header/name, case ignored." />
        </section>
    </inputs>
    <outputs>
        <data name="index" format="lexicmap_index"/>
    </outputs>
    <tests>
        <test>
            <param name="input_genomes" value="genomes/GCF_001502155.1_ViralProj307776_genomic.fna.gz,genomes/GCF_001502175.1_ViralProj307780_genomic.fna.gz" />
            <section name="advanced_settings">
                <param name="batch_size" value="5000" />
            </section>
            <output name="index" ftype="lexicmap_index">
                <extra_files name="genomes.chunks.bin" value="db.lmi/genomes.chunks.bin" />
                <extra_files name="info.toml" value="db.lmi/info.toml" />
                <extra_files name="masks.bin" value="db.lmi/masks.bin" />
                <extra_files name="genomes.map.bin">
                    <assert_contents>
                        <has_size value="108" />
                    </assert_contents>
                </extra_files>
                <expand macro="genomes_batch" />
                <expand macro="seeds" />
            </output>
        </test>
    </tests>
    <help><![CDATA[
    
    Search sequences against an LexicMap index Database. For more information about settings
    please visit: https://bioinf.shenwei.me/LexicMap/usage/index/

    @info@
        ]]></help>
    <expand macro="citations" />
</tool>