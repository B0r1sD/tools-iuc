<tool id="drug2cell" name="drug2cell" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>Collection of utility functions for gene group activity evaluation in scanpy</description>
    <macros>
        <token name="@TOOL_VERSION@">0.1.2</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <requirements>
        <requirement type="package" version="0.1.2">drug2cell</requirement>
        <requirement type="package" version="1.10.4">scanpy</requirement>
    </requirements>
    <command>
        <![CDATA[
        ## Python script to execute drug2cell scoring and differential expression
        python3 '$script'
        ]]>
    </command>
    <configfiles>
        <configfile name="script">
import scanpy as sc
import drug2cell as d2c

# Load AnnData object
adata = sc.read_h5ad("${adata}")

# Combine ATC Level 1 and Level 2 into a single string

# Perform scoring with raw data or normalized data
d2c.score(adata, use_raw=${use_raw})

# Visualize the specified drug (UMAP)
sc.pl.umap(adata.uns['drug2cell'], color="${drug}", color_map="OrRd", save="umap_plot.png")

# Perform differential expression analysis
sc.tl.rank_genes_groups(adata.uns['drug2cell'], method="wilcoxon", groupby="louvain")
sc.pl.rank_genes_groups_dotplot(adata.uns['drug2cell'], swap_axes=True, dendrogram=False, n_genes=${n_genes}, save="dotplot1.png")

# Prepare arguments for dotplot visualization
plot_args = d2c.util.prepare_plot_args(adata.uns['drug2cell'], categories="${level1}${level2}")
sc.pl.dotplot(adata.uns['drug2cell'], groupby="louvain", swap_axes=True, **plot_args, save="dotplot2.png")
        </configfile>
    </configfiles>
    <inputs>
        <!-- Input: AnnData object (processed scRNA-seq data) -->
        <param name="adata" type="data" format="h5ad" label="AnnData Object" help="Select the processed AnnData object file containing your single-cell RNA-seq data"/>
        <!-- Option to select number of genes to visualize in the dotplot -->
        <param name="n_genes" type="integer" min="1" max="20" label="Number of Genes for Dotplot" help="Specify the number of genes to display in the dotplot (range: 1 to 20)."/>
        <!-- Option for visualizing a specific drug from ChEMBL -->
        <param name="drug" type="text" optional="false" label="Drug (CHEMBL ID)" 
            help="Enter the ChEMBL ID of the drug to visualize.">
            <validator type="empty_field" />
        </param>
        <!-- Option to perform differential expression analysis -->
        <param name="use_raw" type="boolean"  truevalue="True" falsevalue="False" label="Use Raw Data for Drug Scoring" help="Choose whether to use raw data or normalized data for drug scoring."/>
       <!-- categorize data for dotplot -->
        <param name="level1" type="select" label="ATC Level 1" 
            help="Select a single ATC Level 1 category (A-V).">
            <option value="A">A - Alimentary tract and metabolism</option>
            <option value="B">B - Blood and blood-forming organs</option>
            <option value="C">C - Cardiovascular system</option>
            <option value="D">D - Dermatologicals</option>
            <option value="G">G - Genito-urinary system and sex hormones</option>
            <option value="H">H - Systemic hormonal preparations</option>
            <option value="J">J - Antiinfectives for systemic use</option>
            <option value="L">L - Antineoplastic and immunomodulating agents</option>
            <option value="M">M - Musculo-skeletal system</option>
            <option value="N">N - Nervous system</option>
            <option value="P">P - Antiparasitic products</option>
            <option value="R">R - Respiratory system</option>
            <option value="S">S - Sensory organs</option>
            <option value="V">V - Various</option>
        </param>
        <!-- ATC Level 2 Selection -->
        <param name="level2" type="text" label="ATC Level 2" 
        help="Enter a two-digit number to specify the ATC Level 2 category.">
        <validator type="empty_field" />
        </param>
    </inputs>
    
    <outputs>
        <!-- Output: One UMAP Plot -->
        <data name="umap_plot" format="png" label="UMAP Plot" from_work_dir="umap_plot.png"/>
        <!-- Output: First Dotplot for Differential Expression -->
        <data name="dotplot1" format="png" label="Dotplot of Gene Groups" from_work_dir="dotplot1.png"/>
        <!-- Output: Second Dotplot with customized categories -->
        <data name="dotplot2" format="png" label="Dotplot with Custom Categories" from_work_dir="dotplot2.png"/>
    </outputs>
    <tests>
        <test>
            <param name="adata" value="fake_small_data.h5ad"/>
            <param name="use_raw" value="true"/>
            <param name="drug" value="CHEMBL1743048|OBINUTUZUMAB"/>
            <param name="n_genes" value="10"/>
            <!-- todo please add cetegories, how do users know which categories are valid? -->
            <param name="level1" value="B"/>
            <param name="level2" value="01"/>
            <output name="umap_plot" file="umap_plot.png"/>
            <output name="dotplot1" file="dotplot1.png"/>
            <output name="dotplot2" file="dotplot2.png"/>
        </test>
        

    </tests>
    <help>
        <![CDATA[
        This tool uses the drug2cell package to score gene groups based on drug-target data from the ChEMBL database. 
        It performs differential expression analysis to identify gene groups up-regulated in particular clusters and visualizes the results in UMAP and dotplot formats.
        ]]>
    </help>
    <citations>
        <citation type="doi">10.1038/s41586-023-06311-1</citation>
    </citations>
</tool>
